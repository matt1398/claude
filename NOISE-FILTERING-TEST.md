# Noise Filtering Test Documentation

## Overview

The noise filtering test (`test-noise-filtering.ts`) verifies that the system correctly identifies and filters out "noise" messages that should not trigger chunk creation. Noise messages include local commands like `/usage`, `/mcp`, `/exit`, and system messages.

## Purpose

Real user input should create chunks, but local commands and system messages should not. This test ensures:

1. Local commands (e.g., `/usage`, `/mcp`, `/model`, `/exit`) are identified as noise
2. System messages with `<command-name>` tags are filtered
3. Messages with `<local-command-caveat>` or `<local-command-stdout>` are ignored
4. A session containing only noise messages produces **zero chunks**

## Test File

The test uses `example_jsonl/agent/example_4.jsonl`, which contains only local command messages:
- `/usage` command
- `/mcp` command
- `/model` command
- `/exit` command
- Associated system messages and outputs

This file has 13 messages, all of which are noise. A properly functioning noise filter should produce **0 chunks** from this file.

## Running the Test

```bash
npm run test:noise
```

## What the Test Checks

### Test 1: Zero Chunks from Noise-Only File ❌ (Currently Failing)
- **Expected**: 0 chunks
- **Actual**: 6 chunks (one for each command message pair)
- **Why it fails**: ChunkBuilder doesn't yet filter noise messages
- **Impact**: Noise messages incorrectly appear as user interactions in the visualization

### Test 2: All Messages Identified as Noise ✅ (Passing)
- **Result**: All 13 messages correctly identified as noise
- **Why it passes**: The `isNoiseMessage()` helper correctly identifies:
  - `isMeta: true` messages
  - `type: "system"` messages
  - Messages containing `<command-name>`, `<local-command-caveat>`, `<local-command-stdout>`

### Test 3: No Trigger Messages ✅ (Passing)
- **Result**: 0 trigger messages found
- **Why it passes**: The `isTriggerMessage()` helper correctly filters out all noise

### Test 4: Command-Specific Filtering ❌ (Currently Failing)
- **Found**: 13 command-related message indicators
- **Result**: Should produce 0 chunks, but produces 6
- **Why it fails**: ChunkBuilder needs to integrate the noise detection logic

## Noise Detection Logic

The test implements two key helper functions:

### `isNoiseMessage(msg: ParsedMessage): boolean`
Returns `true` for messages that should NOT create chunks:
- Messages with `isMeta: true`
- Messages with `type: "system"`
- Messages containing noise indicators:
  - `<command-name>` - local command wrapper
  - `<local-command-caveat>` - caveat about local commands
  - `<local-command-stdout>` - command output
  - `<local-command-message>` - command message
  - `<command-args>` - command arguments

### `isTriggerMessage(msg: ParsedMessage): boolean`
Returns `true` for messages that SHOULD create chunks:
- Must be a real user message (`isRealUserMessage()`)
- Must NOT be a noise message (`!isNoiseMessage()`)

## Expected Behavior After Fix

Once noise filtering is implemented in ChunkBuilder:

```typescript
// BEFORE (current behavior):
Real user messages (string content):    6
Noise messages:                         13
Trigger messages:                       0
Chunks created:                         6 ❌

// AFTER (expected behavior):
Real user messages (string content):    6
Noise messages:                         13
Trigger messages:                       0
Chunks created:                         0 ✅
```

## Example Noise Messages

### Local Command Example
```json
{
  "type": "user",
  "isMeta": false,
  "message": {
    "role": "user",
    "content": "<command-name>/mcp</command-name>\n<command-message>mcp</command-message>\n<command-args></command-args>"
  }
}
```
**Noise indicators**: Contains `<command-name>` tag

### Command Output Example
```json
{
  "type": "user",
  "isMeta": false,
  "message": {
    "role": "user",
    "content": "<local-command-stdout>No MCP servers configured...</local-command-stdout>"
  }
}
```
**Noise indicators**: Contains `<local-command-stdout>` tag

### Caveat Message Example
```json
{
  "type": "user",
  "isMeta": true,
  "message": {
    "role": "user",
    "content": "<local-command-caveat>Caveat: The messages below were generated by the user while running local commands...</local-command-caveat>"
  }
}
```
**Noise indicators**: `isMeta: true` AND contains `<local-command-caveat>` tag

## Integration with ChunkBuilder

To fix the failing tests, ChunkBuilder needs to:

1. **Import or implement noise detection logic**
   ```typescript
   function isNoiseMessage(msg: ParsedMessage): boolean {
     // Check isMeta, type, and content indicators
   }
   ```

2. **Filter noise messages before chunk creation**
   ```typescript
   buildChunks(messages: ParsedMessage[]): Chunk[] {
     // Filter out noise messages first
     const triggerMessages = messages.filter(msg =>
       isRealUserMessage(msg) && !isNoiseMessage(msg)
     );

     // Build chunks only from trigger messages
     // ...
   }
   ```

3. **Ensure noise messages don't start chunks**
   - Local commands should never create new chunks
   - Only genuine user input should trigger chunk creation

## Success Criteria

The test will pass when:
- ✅ All 4 test cases pass
- ✅ A noise-only file produces 0 chunks
- ✅ Command messages are filtered correctly
- ✅ The visualization shows only real user interactions

## Related Files

- `test-noise-filtering.ts` - This test file
- `src/main/services/ChunkBuilder.ts` - Needs noise filtering implementation
- `src/main/utils/jsonl.ts` - Contains message type guards
- `src/main/types/claude.ts` - ParsedMessage type definitions
- `example_jsonl/agent/example_4.jsonl` - Test data (noise-only session)

## Why This Matters

Without noise filtering:
- **Visualization pollution**: Local commands appear as user interactions
- **Misleading metrics**: Chunk count includes non-productive interactions
- **Poor UX**: Users see noise alongside real work in session history
- **Inaccurate analysis**: Session duration includes command overhead

With noise filtering:
- **Clean visualization**: Only real user requests and responses
- **Accurate metrics**: Chunk count reflects actual user interactions
- **Better UX**: Clear separation between work and commands
- **Meaningful analysis**: True picture of session productivity
